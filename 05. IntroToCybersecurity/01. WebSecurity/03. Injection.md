# Injection

## Shell Command

- Imagine an application that needs to run the 'date' system command
- The code for this system command resides in `/user/bin/date`
- **system()**: an operation that exists in many languages that is used to execute a program
- **execve()**: a system call that launches a process

---

### Example

`system('date')`<br>
`execve("/bin/sh", ["sh", "-c", "date"], {...})`<br>
`execve("/usr/bin/date", ["date"], {...})`<br>

---

- Here, we are calling `system()` on the `date` program
- The first execve() command launches a shell, parses the argument (`date`), and executes it in the shell
  - **Shell**: job is to parse your statement and convert it into program invocations
  - **-c**: flag that specifies the shell to parse the argument and run it, as if the user typed it into the terminal and ran it himself
- The second execve() command attempts to find the location of the `date` program within the shell

## Environment Variables

- We can specify the timezone for the date
- We put environment variables before the program we want to run in order to do this

---

### Example: UTC

`system("TZ=UTC date")`<br>
`execve("/bin/sh", ["sh", "-c", "TZ=UTC date"], {...})`<br>
`execve("/usr/bin/date", ["date"], {"TZ": "UTC"})`<br>

<p align="center">
  <img src="https://github.com/thespcrewroy/Pwn.College/blob/main/05.%20IntroToCybersecurity/01.%20WebSecurity/assets/tz-utc.png" alt="Demo" width="500" />
</p>

### Example: MST

`system("TZ=MST date")`<br>
`execve("/bin/sh", ["sh", "-c", "TZ=MST date"], {...})`<br>
`execve("/usr/bin/date", ["date"], {"TZ": "MST"})`<br>

<p align="center">
  <img src="https://github.com/thespcrewroy/Pwn.College/blob/main/05.%20IntroToCybersecurity/01.%20WebSecurity/assets/tz-mst.png" alt="Demo" width="500" />
</p>

---

- Useful if we want different users from different timezones accessing the program
- We can also take a user response and inject that user-specified timezone into the website

## Command Injection: Part 1

- Issue: all we are doing is concatenating `TZ=<userInput>+date` and just pushing it off to the shell to execute
- **Backtick Operator (`` ` ``)**: if you specify another system program as an environment variable in between two backticks, the shell executes that program and uses the output of that command as the new timezone

  ***

### Example

`` system("TZ=`whoami` date") `` <br>
`` execve("/bin/sh", ["sh", "-c", "TZ=`whoami` date"], {...}) `` <br>
`execve("/usr/bin/whoami", ["whoami"], {...})` <br>
`execve("/usr/bin/date", ["date"], {"TZ": "root"})`

<p align="left">
  <img src="https://github.com/thespcrewroy/Pwn.College/blob/main/05.%20IntroToCybersecurity/01.%20WebSecurity/assets/command-injection1.png" alt="Demo" width="500" />
  <img src="https://github.com/thespcrewroy/Pwn.College/blob/main/05.%20IntroToCybersecurity/01.%20WebSecurity/assets/command-injection2.png" alt="Demo" width="500" />
</p>

---

- The shell tries to run the `/user/bin/whoami` program to subsitute the output of the `whoami` command in for the `TZ` env variable
- Once the shell receives the output of `whoami` (in our case, it is _root_), it is passed into the `TZ` environment variable
- Now `/user/bin/date` is ran with the timezone of `root`

## Command Injection: Part 2

- We now understand that we have a very aggressive level of control over the launching shell if we have user input
- We can start our user input with a semicolon (`;`)

---

### Example

`system("TZ=; whoami # date")`<br>
`execve("/bin/sh", ["sh", "-c", "TZ=; whoami # date"], {...})`<br>
`execve("/usr/bin/whoami", ["whoami"], {...})`<br>

<p align="center">
  <img src="https://github.com/thespcrewroy/Pwn.College/blob/main/05.%20IntroToCybersecurity/01.%20WebSecurity/assets/command-injection3.png" alt="Demo" width="500" />
</p>

---

- The semicolon specifies that we are passing in the empty string into the `TZ` environment variable
- After we end that shell statement, we move onto the next line in the shell to begin a new shell statement
- In this newline, we run the `whoami` command
- At the end of the statement, there is a space and a pound (`#`) symbol that follows
  - This pound (`#`) symbol comments out (ignores) the rest of the command, which in our case is `date`
  - Thus, instead of executing `whoami date`, we execute `whoami`
- It doesn't have to be `whoami`; now any program can be run if placed between the semicolon and pound symbols

## HTML Injection

- **html_response()**: we can supply any daya we want as it is up to the server to move and execute this arbitrary data
- You are not in a _text_ context, you are in an _HTML_ context

---

### Example

`html_response("<p>Hello, Connor!</p>")`<br>
`html_response("<p>Hello, <script>alert(1)</script>!</p>")`

<p align="left">
  <img src="https://github.com/thespcrewroy/Pwn.College/blob/main/05.%20IntroToCybersecurity/01.%20WebSecurity/assets/html.png" alt="Demo" width="500" />
  <img src="https://github.com/thespcrewroy/Pwn.College/blob/main/05.%20IntroToCybersecurity/01.%20WebSecurity/assets/html-injection.png" alt="Demo" width="500" />
</p>

---

- **`<script>`**: tag that allows you to manipulate the frontend by running arbitrary javascript within the HTML context
- Rather than running this locally and not doing much, a malicious actor can inject javascript into a field that gets inputted into a database and sent to a server, and not the malicious actor can run javascript on someone else's system
- Sanitization Technique:
  - Force your username only has alphanumeric characters
  - Encode characters into HTML character entities to remove them from an pure HTML context. Ex. writing `>` as `&gt;`. This will display a `>` symbol without treating the symbol as an HTML tag of a `>` symbol

## SQL Injection
* Usually the ```admin``` has the highest privelages so it is best to specify the *username* as ```admin```
* **``` password = '' OR 1=1 --'" ```**:
  * The ```--``` is a comment operator that specifies everything after it should be ignored
  * Specifies that the password is either the empty string or a TRUE statement (here, we chose ```1=1```)
  * The above specification means that whatever we put into the password field will evaluate to TRUE
  * As a result, we select from USERS ONLY where the username is ```admin```!
* Sanitization Techniques
  * Replace username and password with question marks
  * SQL parses out the query, and binds the data in after-the-fact
  * Parsing before data filling is always safer than the other way around, which is what SQL and most other languages support
